<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrimeDev AI ‚Äî by PRIME DEV</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark-dimmed.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<style>
  :root {
    --bg:#0f0f13;--sidebar:#161620;--surface:#1c1c28;--border:#2e2e42;
    --accent:#6c63ff;--accent-glow:rgba(108,99,255,0.15);--accent2:#ff6584;
    --green:#43e97b;--text:#e8e8f5;--text2:#9898b8;--muted:#55556a;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden}

  /* SIDEBAR */
  .sidebar{width:260px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:20px 14px;flex-shrink:0}
  .brand{display:flex;align-items:center;gap:10px;padding:8px 10px 20px;border-bottom:1px solid var(--border);margin-bottom:16px}
  .brand-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:18px}
  .brand-text .name{font-size:15px;font-weight:800}
  .brand-text .by{font-size:10px;color:var(--muted);font-family:'Fira Code',monospace}
  .new-chat-btn{width:100%;padding:10px 14px;background:var(--accent-glow);border:1px solid rgba(108,99,255,0.3);border-radius:10px;color:var(--accent);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.2s;margin-bottom:16px}
  .new-chat-btn:hover{background:rgba(108,99,255,0.25);border-color:var(--accent)}
  .sidebar-section{font-size:10px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase;padding:0 10px;margin-bottom:8px}
  .history-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:3px;margin-bottom:12px}
  .history-list::-webkit-scrollbar{width:3px}
  .history-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  .history-item{padding:9px 12px;border-radius:10px;font-size:12.5px;color:var(--text2);cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:8px}
  .history-item:hover{background:var(--surface);color:var(--text)}
  .history-item.active{background:var(--accent-glow);color:var(--accent);border:1px solid rgba(108,99,255,0.2)}
  .history-item .h-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .history-item .h-del{opacity:0;font-size:11px;padding:2px 6px;border-radius:4px;background:rgba(255,100,100,0.1);color:#ff6b6b;transition:opacity 0.15s;flex-shrink:0}
  .history-item:hover .h-del{opacity:1}
  .no-history{font-size:12px;color:var(--muted);text-align:center;padding:20px 10px;font-family:'Fira Code',monospace}
  .quick-item{padding:8px 12px;border-radius:10px;font-size:12px;color:var(--text2);cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:8px}
  .quick-item:hover{background:var(--surface);color:var(--text)}
  .sidebar-footer{border-top:1px solid var(--border);padding-top:12px;font-size:11px;color:var(--muted);text-align:center;font-family:'Fira Code',monospace}
  .online-badge{display:inline-flex;align-items:center;gap:5px;color:var(--green);margin-bottom:4px}
  .online-badge::before{content:'';width:6px;height:6px;background:var(--green);border-radius:50%;box-shadow:0 0 6px var(--green);animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

  /* MAIN */
  .main{flex:1;display:flex;flex-direction:column;overflow:hidden}
  .topbar{padding:14px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(15,15,19,0.9);backdrop-filter:blur(10px);flex-shrink:0}
  .topbar-title{font-size:15px;font-weight:700}
  .icon-btn{height:32px;padding:0 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:6px;font-size:12px;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.15s}
  .icon-btn:hover{color:var(--text);border-color:var(--accent)}

  /* CHAT */
  #chat{flex:1;overflow-y:auto;padding:32px 0 16px;display:flex;flex-direction:column;scroll-behavior:smooth}
  #chat::-webkit-scrollbar{width:5px}
  #chat::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

  /* WELCOME */
  #welcome{margin:auto;text-align:center;padding:20px;animation:fadeUp 0.5s ease;max-width:580px}
  @keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
  #welcome .emoji{font-size:52px;margin-bottom:20px;display:block}
  #welcome h2{font-size:26px;font-weight:800;margin-bottom:10px;background:linear-gradient(135deg,#fff 0%,var(--accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  #welcome p{color:var(--text2);font-size:14px;line-height:1.7;margin-bottom:28px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  .chip{padding:8px 14px;background:var(--surface);border:1px solid var(--border);border-radius:30px;font-size:12.5px;color:var(--text2);cursor:pointer;transition:all 0.2s;font-family:'Fira Code',monospace}
  .chip:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}

  /* MESSAGES */
  .msg-row{padding:10px 24px;display:flex;gap:14px;max-width:920px;width:100%;margin:0 auto;animation:fadeUp 0.25s ease}
  .msg-row.user{flex-direction:row-reverse}
  .avatar{width:32px;height:32px;border-radius:9px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:15px;margin-top:2px}
  .msg-row.user .avatar{background:linear-gradient(135deg,var(--accent2),#c850c0)}
  .msg-row.ai .avatar{background:linear-gradient(135deg,var(--accent),#38b2ff)}
  .msg-content{flex:1;min-width:0}
  .msg-name{font-size:11.5px;font-weight:700;color:var(--text2);margin-bottom:5px}
  .msg-row.user .msg-name{text-align:right}
  .msg-bubble{line-height:1.7;font-size:14.5px;word-break:break-word}
  .msg-row.user .msg-bubble{background:var(--accent-glow);border:1px solid rgba(108,99,255,0.25);border-radius:16px;border-top-right-radius:4px;padding:10px 14px;display:inline-block;float:right;max-width:100%}
  .msg-row.ai .msg-bubble{display:block}

  /* AI markdown */
  .msg-row.ai .msg-bubble p{margin-bottom:12px;line-height:1.75}
  .msg-row.ai .msg-bubble p:last-child{margin-bottom:0}
  .msg-row.ai .msg-bubble h1,.msg-row.ai .msg-bubble h2,.msg-row.ai .msg-bubble h3{font-weight:700;margin:16px 0 8px;color:#fff}
  .msg-row.ai .msg-bubble h1{font-size:18px}.msg-row.ai .msg-bubble h2{font-size:16px}.msg-row.ai .msg-bubble h3{font-size:15px}
  .msg-row.ai .msg-bubble ul,.msg-row.ai .msg-bubble ol{padding-left:20px;margin-bottom:12px}
  .msg-row.ai .msg-bubble li{margin-bottom:4px;line-height:1.65}
  .msg-row.ai .msg-bubble blockquote{border-left:3px solid var(--accent);padding-left:14px;margin:12px 0;color:var(--text2);font-style:italic}
  .msg-row.ai .msg-bubble hr{border:none;border-top:1px solid var(--border);margin:16px 0}
  .msg-row.ai .msg-bubble strong{color:#fff;font-weight:700}
  .msg-row.ai .msg-bubble code:not(pre code){background:rgba(108,99,255,0.12);color:#a89fff;padding:2px 7px;border-radius:5px;font-family:'Fira Code',monospace;font-size:13px}

  /* CODE BLOCK - scroll vertical, bisa download */
  .code-wrap{background:#0d0d14;border:1px solid var(--border);border-radius:12px;overflow:hidden;margin:12px 0}
  .code-header{display:flex;align-items:center;justify-content:space-between;padding:9px 14px;background:#13131f;border-bottom:1px solid var(--border);gap:8px}
  .code-lang{font-size:11px;color:#7c7c9a;font-family:'Fira Code',monospace;text-transform:uppercase;letter-spacing:0.5px}
  .code-actions{display:flex;gap:6px;align-items:center}
  .code-btn{padding:3px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:11px;cursor:pointer;font-family:'Fira Code',monospace;transition:all 0.15s;white-space:nowrap}
  .code-btn:hover{color:var(--accent);border-color:var(--accent)}
  .code-btn.copied{color:var(--green);border-color:var(--green)}
  .code-btn.download{color:#f9ca24}
  .code-btn.download:hover{border-color:#f9ca24;color:#f9ca24}

  /* KODE BISA SCROLL VERTIKAL, TIDAK TERPOTONG */
  .code-wrap pre{margin:0;overflow:visible}
  .code-wrap pre code{
    font-family:'Fira Code',monospace;
    font-size:13px;
    padding:16px!important;
    display:block;
    white-space:pre;        /* jaga format asli */
    word-break:normal;
    overflow-x:auto;        /* scroll horizontal kalau beneran panjang */
    line-height:1.65;
    max-height:none;        /* TIDAK dibatasi tinggi = semua baris tampil */
  }

  /* Typing */
  .typing-dots{display:flex;gap:5px;align-items:center;padding:4px 0}
  .typing-dots span{width:7px;height:7px;background:var(--accent);border-radius:50%;animation:blink 1.4s infinite}
  .typing-dots span:nth-child(2){animation-delay:0.2s}
  .typing-dots span:nth-child(3){animation-delay:0.4s}
  @keyframes blink{0%,80%,100%{opacity:0.2;transform:scale(0.8)}40%{opacity:1;transform:scale(1)}}

  /* INPUT */
  #input-area{padding:12px 24px 18px;background:var(--bg);border-top:1px solid var(--border);flex-shrink:0}
  .input-wrapper{max-width:920px;margin:0 auto}
  #file-preview{display:none;align-items:center;gap:8px;padding:8px 12px;background:var(--accent-glow);border:1px solid rgba(108,99,255,0.2);border-radius:10px;margin-bottom:8px;font-size:12.5px;color:var(--text2);font-family:'Fira Code',monospace}
  #file-preview.show{display:flex}
  #file-preview .remove-file{cursor:pointer;color:#ff6b6b;margin-left:auto;font-size:14px}
  .input-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:10px 12px;display:flex;gap:10px;align-items:flex-end;transition:border-color 0.2s,box-shadow 0.2s}
  .input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
  .attach-btn{width:34px;height:34px;background:none;border:none;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;border-radius:8px;transition:all 0.15s;flex-shrink:0}
  .attach-btn:hover{color:var(--accent);background:var(--accent-glow)}
  #user-input{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:14.5px;resize:none;max-height:160px;line-height:1.55}
  #user-input::placeholder{color:var(--muted)}
  #send-btn{width:36px;height:36px;background:var(--accent);border:none;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s}
  #send-btn:hover{background:#5a52e8;transform:scale(1.05)}
  #send-btn:disabled{background:var(--border);cursor:not-allowed;transform:none}
  #send-btn svg{width:16px;height:16px;fill:white}
  .input-footer{display:flex;justify-content:space-between;align-items:center;margin-top:7px;padding:0 4px}
  .input-hint{font-size:11px;color:var(--muted);font-family:'Fira Code',monospace}
  .model-badge{font-size:11px;color:var(--muted);font-family:'Fira Code',monospace;background:var(--surface);padding:3px 8px;border-radius:6px;border:1px solid var(--border)}
  #file-input{display:none}
  @media(max-width:768px){.sidebar{display:none}}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="brand">
    <div class="brand-icon">üíª</div>
    <div class="brand-text">
      <div class="name">PrimeDev AI</div>
      <div class="by">by PRIME DEV</div>
    </div>
  </div>
  <button class="new-chat-btn" onclick="newChat()">‚úèÔ∏è Chat Baru</button>
  <div class="sidebar-section">Riwayat Chat</div>
  <div class="history-list" id="history-list"><div class="no-history">Belum ada riwayat</div></div>
  <div class="sidebar-section">Topik Cepat</div>
  <div style="display:flex;flex-direction:column;gap:3px;margin-bottom:12px">
    <div class="quick-item" onclick="sendSuggestion('Cara buat script Roblox')">üéÆ Roblox Script</div>
    <div class="quick-item" onclick="sendSuggestion('Cara debug error Python')">üêç Python Debug</div>
    <div class="quick-item" onclick="sendSuggestion('Cara membuat loop JavaScript')">‚ö° JavaScript</div>
    <div class="quick-item" onclick="sendSuggestion('Contoh query SQL JOIN')">üóÑÔ∏è SQL</div>
  </div>
  <div class="sidebar-footer">
    <div class="online-badge">Online</div>
    <div>llama-3.3-70b</div>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbar-title">üí¨ Chat Baru</div>
    <div style="display:flex;gap:8px">
      <button class="icon-btn" onclick="newChat()">üóëÔ∏è Bersihkan</button>
    </div>
  </div>

  <div id="chat">
    <div id="welcome">
      <span class="emoji">üë®‚Äçüíª</span>
      <h2>Halo! Saya PrimeDev AI</h2>
      <p>Asisten coding buatan <strong style="color:#a89fff">PRIME DEV</strong>.<br>Tanya apa saja, atau upload file kode untuk direview!</p>
      <div class="chips">
        <span class="chip" onclick="sendSuggestion(this.textContent)">Apa itu REST API?</span>
        <span class="chip" onclick="sendSuggestion(this.textContent)">Fix error Python</span>
        <span class="chip" onclick="sendSuggestion(this.textContent)">Buat loop JavaScript</span>
        <span class="chip" onclick="sendSuggestion(this.textContent)">Apa itu async/await?</span>
        <span class="chip" onclick="sendSuggestion(this.textContent)">Contoh SQL JOIN</span>
        <span class="chip" onclick="sendSuggestion(this.textContent)">Script Roblox Lua</span>
      </div>
    </div>
  </div>

  <div id="input-area">
    <div class="input-wrapper">
      <div id="file-preview">
        <span>üìé</span>
        <span id="file-name">file.txt</span>
        <span class="remove-file" onclick="removeFile()">‚úï</span>
      </div>
      <div class="input-box">
        <button class="attach-btn" onclick="document.getElementById('file-input').click()" title="Upload file kode">üìé</button>
        <input type="file" id="file-input" accept=".js,.ts,.py,.lua,.html,.css,.json,.txt,.php,.java,.cpp,.c,.cs,.go,.rb,.swift,.kt,.rs,.sql,.xml,.yaml,.yml,.sh,.bat,.md" onchange="handleFile(this)">
        <textarea id="user-input" rows="1" placeholder="Tanya tentang coding, atau upload file kode kamu..."></textarea>
        <button id="send-btn" onclick="sendMessage()">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
      <div class="input-footer">
        <span class="input-hint">üìé Upload file kode ‚Ä¢ Enter kirim ‚Ä¢ Shift+Enter baris baru</span>
        <span class="model-badge">llama-3.3-70b</span>
      </div>
    </div>
  </div>
</main>

<script>
  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');
  const welcomeEl = document.getElementById('welcome');
  const historyListEl = document.getElementById('history-list');

  let history = [];
  let sessions = JSON.parse(localStorage.getItem('primedev_sessions') || '[]');
  let currentSessionId = null;
  let isLoading = false;
  let pendingFile = null;

  renderHistoryList();

  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + 'px';
  });

  function handleFile(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      pendingFile = { name: file.name, content: e.target.result };
      document.getElementById('file-name').textContent = file.name;
      document.getElementById('file-preview').classList.add('show');
      if (!inputEl.value) inputEl.value = 'Tolong review file kode ini dan berikan saran perbaikan:';
      inputEl.focus();
    };
    reader.readAsText(file);
    input.value = '';
  }

  function removeFile() {
    pendingFile = null;
    document.getElementById('file-preview').classList.remove('show');
  }

  function sendSuggestion(text) { inputEl.value = text; sendMessage(); }

  function newChat() {
    if (history.length > 0) saveCurrentSession();
    history = []; currentSessionId = null;
    chatEl.innerHTML = '';
    chatEl.appendChild(welcomeEl);
    welcomeEl.style.display = '';
    inputEl.value = ''; inputEl.style.height = 'auto';
    pendingFile = null;
    document.getElementById('file-preview').classList.remove('show');
    document.getElementById('topbar-title').textContent = 'üí¨ Chat Baru';
    document.querySelectorAll('.history-item').forEach(i => i.classList.remove('active'));
  }

  function saveCurrentSession() {
    if (!history.length) return;
    const firstMsg = history.find(m => m.role === 'user');
    const title = firstMsg ? (firstMsg.displayContent || firstMsg.content).slice(0, 45) + '...' : 'Chat';
    if (currentSessionId) {
      const idx = sessions.findIndex(s => s.id === currentSessionId);
      if (idx !== -1) { sessions[idx].history = [...history]; sessions[idx].title = title; }
    } else {
      currentSessionId = Date.now().toString();
      sessions.unshift({ id: currentSessionId, title, history: [...history], time: Date.now() });
      if (sessions.length > 30) sessions = sessions.slice(0, 30);
    }
    localStorage.setItem('primedev_sessions', JSON.stringify(sessions));
    renderHistoryList();
  }

  function loadSession(id) {
    if (history.length > 0) saveCurrentSession();
    const session = sessions.find(s => s.id === id);
    if (!session) return;
    currentSessionId = id; history = [...session.history];
    chatEl.innerHTML = '';
    history.forEach(msg => {
      if (msg.role === 'user') appendMessage('user', msg.displayContent || msg.content);
      else appendMessage('ai', msg.content);
    });
    document.getElementById('topbar-title').textContent = 'üí¨ ' + session.title;
    document.querySelectorAll('.history-item').forEach(i => i.classList.remove('active'));
    document.querySelector(`[data-id="${id}"]`)?.classList.add('active');
  }

  function deleteSession(id, e) {
    e.stopPropagation();
    sessions = sessions.filter(s => s.id !== id);
    localStorage.setItem('primedev_sessions', JSON.stringify(sessions));
    if (currentSessionId === id) newChat();
    renderHistoryList();
  }

  function renderHistoryList() {
    if (!sessions.length) { historyListEl.innerHTML = '<div class="no-history">Belum ada riwayat</div>'; return; }
    historyListEl.innerHTML = sessions.map(s => `
      <div class="history-item ${s.id === currentSessionId ? 'active' : ''}" data-id="${s.id}" onclick="loadSession('${s.id}')">
        <span style="font-size:13px">üí¨</span>
        <span class="h-title">${escHtml(s.title)}</span>
        <span class="h-del" onclick="deleteSession('${s.id}', event)">‚úï</span>
      </div>`).join('');
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if ((!text && !pendingFile) || isLoading) return;
    welcomeEl.style.display = 'none';

    let userDisplayContent = text;
    let apiContent = text;

    if (pendingFile) {
      const ext = pendingFile.name.split('.').pop();
      apiContent = (text || 'Tolong review file kode ini dan berikan saran perbaikan:') + `\n\n\`\`\`${ext}\n// File: ${pendingFile.name}\n${pendingFile.content}\n\`\`\``;
      userDisplayContent = (text || 'Tolong review file kode ini:') + `\n\nüìé ${pendingFile.name}`;
      removeFile();
    }

    appendMessage('user', userDisplayContent);
    history.push({ role: 'user', content: apiContent, displayContent: userDisplayContent });
    inputEl.value = ''; inputEl.style.height = 'auto';

    const typingId = showTyping();
    isLoading = true; sendBtn.disabled = true;

    try {
      const res = await fetch('/api/chat', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: history.map(m => ({ role: m.role, content: m.content })) })
      });
      removeTyping(typingId);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Request gagal');
      history.push({ role: 'assistant', content: data.reply });
      appendMessage('ai', data.reply);
      saveCurrentSession();
    } catch (err) {
      removeTyping(typingId);
      appendMessage('ai', `‚ùå **Error:** ${err.message}`);
    } finally {
      isLoading = false; sendBtn.disabled = false; inputEl.focus();
    }
  }

  function appendMessage(role, content) {
    const row = document.createElement('div');
    row.className = `msg-row ${role}`;
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';
    const mc = document.createElement('div');
    mc.className = 'msg-content';
    const nm = document.createElement('div');
    nm.className = 'msg-name';
    nm.textContent = role === 'user' ? 'Kamu' : 'PrimeDev AI';
    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    if (role === 'ai') {
      bubble.innerHTML = renderMarkdown(content);
      bubble.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
    } else {
      bubble.innerHTML = escHtml(content).replace(/\n/g, '<br>');
    }
    mc.appendChild(nm); mc.appendChild(bubble);
    row.appendChild(avatar); row.appendChild(mc);
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  let codeBlockCount = 0;
  function renderMarkdown(text) {
    // Code blocks dengan tombol Copy + Download
    text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
      const l = lang || 'code';
      const id = 'cb_' + (++codeBlockCount);
      const trimmed = code.trim();
      // Tentukan ekstensi file untuk download
      const extMap = {lua:'lua',python:'py',py:'py',javascript:'js',js:'js',typescript:'ts',ts:'ts',html:'html',css:'css',php:'php',java:'java',cpp:'cpp',c:'c',sql:'sql',json:'json',sh:'sh',bash:'sh',go:'go',rb:'rb',ruby:'rb',kotlin:'kt',swift:'swift',xml:'xml',yaml:'yml',yml:'yml'};
      const ext = extMap[l.toLowerCase()] || 'txt';
      const fname = `code_${id}.${ext}`;
      return `<div class="code-wrap">
        <div class="code-header">
          <span class="code-lang">${l}</span>
          <div class="code-actions">
            <button class="code-btn download" onclick="downloadCode('${id}','${fname}')">‚¨á Download</button>
            <button class="code-btn" id="copy_${id}" onclick="copyCode('${id}')">Copy</button>
          </div>
        </div>
        <pre><code id="${id}" class="language-${l}">${escHtml(trimmed)}</code></pre>
      </div>`;
    });

    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    text = text.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    text = text.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    text = text.replace(/^# (.+)$/gm, '<h1>$1</h1>');
    text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
    text = text.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
    text = text.replace(/^---$/gm, '<hr>');
    text = text.replace(/^\d+\. (.+)$/gm, '<li style="list-style:decimal">$1</li>');
    text = text.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
    text = text.split(/\n\n+/).map(p => {
      p = p.trim();
      if (!p) return '';
      if (/^<(h[123]|div|ol|ul|blockquote|hr|li)/.test(p)) return p;
      return `<p>${p.replace(/\n/g, '<br>')}</p>`;
    }).join('');
    return text;
  }

  function copyCode(id) {
    const code = document.getElementById(id)?.textContent || '';
    navigator.clipboard.writeText(code).then(() => {
      const btn = document.getElementById('copy_' + id);
      if (btn) { btn.textContent = '‚úì Copied!'; btn.classList.add('copied'); setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000); }
    });
  }

  function downloadCode(id, filename) {
    const code = document.getElementById(id)?.textContent || '';
    const blob = new Blob([code], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function escHtml(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function showTyping() {
    const id = 'typing_' + Date.now();
    const row = document.createElement('div');
    row.className = 'msg-row ai'; row.id = id;
    const av = document.createElement('div'); av.className = 'avatar'; av.textContent = 'ü§ñ';
    const mc = document.createElement('div'); mc.className = 'msg-content';
    const nm = document.createElement('div'); nm.className = 'msg-name'; nm.textContent = 'PrimeDev AI';
    const bub = document.createElement('div'); bub.className = 'msg-bubble';
    bub.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
    mc.appendChild(nm); mc.appendChild(bub); row.appendChild(av); row.appendChild(mc);
    chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;
    return id;
  }

  function removeTyping(id) { const el = document.getElementById(id); if (el) el.remove(); }
</script>
</body>
</html>
